{% extends 'providers/domain/base.html' %}

{% block domain_title %}Domain Settings{% endblock %}

{% block domain_content %}
    <!-- Provider Info -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-shop"></i> {{ provider.business_name }} - Booking URLs</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Business Name:</strong> {{ provider.business_name }}</p>
                    <p class="mb-1"><strong>Your Unique Slug:</strong> <code>{{ provider.unique_booking_url }}</code></p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Business Type:</strong> {{ provider.get_business_type_display }}</p>
                    <p class="mb-1"><strong>Plan:</strong> 
                        {% if provider.is_pro %}
                            <span class="badge bg-success">PRO</span>
                        {% else %}
                            <span class="badge bg-secondary">FREE</span>
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <hr>
            
            <h6><i class="bi bi-link-45deg"></i> Your Default Booking URL</h6>
            <div class="input-group mb-3">
                <span class="input-group-text bg-light">https://</span>
                <input type="text" class="form-control form-control-lg" 
                       value="{{ default_domain }}/book/{{ provider.unique_booking_url }}/" 
                       readonly id="defaultUrl">
                <button class="btn btn-primary" type="button" onclick="copyToClipboard('defaultUrl')">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
            <p class="text-muted small">
                <i class="bi bi-info-circle"></i> This is YOUR unique booking page. Only your services and availability are shown here.
            </p>
            
            {% if provider.custom_domain and provider.domain_verified %}
            <hr>
            <h6><i class="bi bi-globe"></i> Your Custom Domain URL</h6>
            <div class="input-group mb-3">
                <span class="input-group-text bg-success text-white">
                    <i class="bi bi-lock-fill"></i> https://
                </span>
                <input type="text" class="form-control form-control-lg" 
                       value="{{ provider.custom_domain }}" 
                       readonly id="customUrl">
                <button class="btn btn-success" type="button" onclick="copyToClipboard('customUrl')">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
            <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle-fill"></i>
                <span class="badge bg-success">Verified & Active</span>
                Your custom domain is working! Customers visiting <code>{{ provider.custom_domain }}</code> will see YOUR booking page.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Current Domain Status -->
    <div class="mb-4">
        <h5><i class="bi bi-globe2"></i> Custom Domain Status</h5>
        {% if provider.custom_domain %}
            <div class="alert {% if provider.domain_verified %}alert-success{% else %}alert-warning{% endif %}">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <i class="bi {% if provider.domain_verified %}bi-check-circle-fill{% else %}bi-exclamation-triangle-fill{% endif %}"></i>
                        <strong>{{ provider.custom_domain }}</strong>
                        {% if provider.domain_verified %}
                            <span class="badge bg-success">Verified</span>
                            {% if provider.ssl_enabled %}
                                <span class="badge bg-info">SSL Enabled</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning text-dark">Pending Verification</span>
                        {% endif %}
                    </div>
                    <div class="mt-2 mt-md-0">
                        <small class="text-muted">Links to: <code>/book/{{ provider.unique_booking_url }}/</code></small>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2 flex-wrap">
                {% if not provider.domain_verified %}
                <a href="{% url 'providers:domain_verification' %}" class="btn btn-primary">
                    <i class="bi bi-shield-check"></i> Complete Verification
                </a>
                {% else %}
                <a href="https://{{ provider.custom_domain }}" class="btn btn-success" target="_blank">
                    <i class="bi bi-box-arrow-up-right"></i> Visit Custom Domain
                </a>
                {% endif %}
                <form method="post" action="{% url 'providers:remove_domain' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger" 
                            onclick="return confirm('Are you sure you want to remove this domain?');">
                        <i class="bi bi-trash"></i> Remove Domain
                    </button>
                </form>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                You haven't set up a custom domain yet. Add one below to give your booking page a professional branded URL!
                <br><small>Example: <code>book.{{ provider.business_name|slugify }}.com</code> instead of <code>{{ default_domain }}/book/{{ provider.unique_booking_url }}/</code></small>
            </div>
        {% endif %}
    </div>

    <!-- Add Custom Domain Form -->
    {% if is_pro %}
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Custom Domain for {{ provider.business_name }}</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-light border mb-3">
                <i class="bi bi-lightbulb-fill text-warning"></i>
                <strong>How it works:</strong> Your custom domain (e.g., <code>book.mybusiness.com</code>) will show YOUR booking page with YOUR services. Each provider has their own unique booking URL.
            </div>
            
            <ul class="nav nav-tabs mb-3" id="domainTypeTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="subdomain-tab" data-bs-toggle="tab" 
                            data-bs-target="#subdomain-pane" type="button" role="tab">
                        <i class="bi bi-speedometer2"></i> Subdomain (Easy)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="custom-tab" data-bs-toggle="tab" 
                            data-bs-target="#custom-pane" type="button" role="tab">
                        <i class="bi bi-globe"></i> Your Own Domain
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="domainTypeContent">
                <!-- Subdomain Option -->
                <div class="tab-pane fade show active" id="subdomain-pane" role="tabpanel">
                    <form method="post" action="{% url 'providers:add_custom_domain' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="subdomain" class="form-label">Choose Your Subdomain</label>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control" id="subdomain" name="domain" 
                                       placeholder="{{ provider.unique_booking_url }}" required pattern="[a-z0-9-]+"
                                       title="Only lowercase letters, numbers, and hyphens allowed"
                                       value="{{ provider.unique_booking_url }}">
                                <span class="input-group-text">.{{ default_domain }}</span>
                            </div>
                            <input type="hidden" name="domain_type" value="subdomain">
                            <div class="form-text">
                                Your URL will be: <code><span id="previewSubdomain">{{ provider.unique_booking_url }}</span>.{{ default_domain }}</code>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle"></i> Create Subdomain
                        </button>
                    </form>
                </div>
                
                <!-- Custom Domain Option -->
                <div class="tab-pane fade" id="custom-pane" role="tabpanel">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Requires DNS Access:</strong> You'll need to add CNAME and TXT records at your domain registrar.
                    </div>
                    <form method="post" action="{% url 'providers:add_custom_domain' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="domain" class="form-label">Your Custom Domain</label>
                            <div class="input-group input-group-lg mb-2">
                                <span class="input-group-text">https://</span>
                                <input type="text" class="form-control" id="domain" name="domain" 
                                       placeholder="book.yourbusiness.com" required>
                            </div>
                            <input type="hidden" name="domain_type" value="domain">
                            <div class="form-text">
                                Examples: <code>book.{{ provider.business_name|slugify }}.com</code>, <code>appointments.mybusiness.com</code>, <code>schedule.mysalon.in</code>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle"></i> Add Domain
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card mt-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-lock-fill"></i> Custom Domains - PRO Feature</h5>
        </div>
        <div class="card-body">
            <p>Custom domains are available for PRO users. Upgrade to get:</p>
            <ul>
                <li><i class="bi bi-check-circle text-success"></i> Your own branded booking URL</li>
                <li><i class="bi bi-check-circle text-success"></i> Professional appearance for customers</li>
                <li><i class="bi bi-check-circle text-success"></i> SSL security included</li>
            </ul>
            <a href="{% url 'subscriptions:upgrade' %}" class="btn btn-warning btn-lg">
                <i class="bi bi-arrow-up-circle"></i> Upgrade to PRO
            </a>
        </div>
    </div>
    {% endif %}

    <!-- CNAME Configuration Guide -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-gear"></i> DNS Configuration Guide</h5>
        </div>
        <div class="card-body">
            <p>When you add a custom domain, you'll need to configure DNS records at your domain registrar:</p>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-success">
                        <div class="card-header bg-success text-white">
                            <strong>1. CNAME Record</strong>
                        </div>
                        <div class="card-body">
                            <p class="small">Points your domain to our servers:</p>
                            <table class="table table-sm table-bordered mb-0">
                                <tr>
                                    <td><strong>Type</strong></td>
                                    <td>CNAME</td>
                                </tr>
                                <tr>
                                    <td><strong>Host</strong></td>
                                    <td><code>book</code> (or your choice)</td>
                                </tr>
                                <tr>
                                    <td><strong>Value</strong></td>
                                    <td><code>{{ default_domain }}</code></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-info">
                        <div class="card-header bg-info text-white">
                            <strong>2. TXT Record</strong>
                        </div>
                        <div class="card-body">
                            <p class="small">Proves you own the domain (unique to your account):</p>
                            <table class="table table-sm table-bordered mb-0">
                                <tr>
                                    <td><strong>Type</strong></td>
                                    <td>TXT</td>
                                </tr>
                                <tr>
                                    <td><strong>Host</strong></td>
                                    <td><code>_booking-verify</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Value</strong></td>
                                    <td><small>(Generated after you add domain)</small></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-light border mt-3">
                <i class="bi bi-info-circle-fill text-primary"></i>
                <strong>Remember:</strong> Each service provider gets their own unique verification code. 
                When customers visit your custom domain, they will only see YOUR booking page for <strong>{{ provider.business_name }}</strong>.
            </div>
        </div>
    </div>

    <script>
    // Preview subdomain as user types
    document.getElementById('subdomain')?.addEventListener('input', function(e) {
        document.getElementById('previewSubdomain').textContent = e.target.value || '{{ provider.unique_booking_url }}';
    });
    
    function copyToClipboard(elementId) {
        var copyText = document.getElementById(elementId);
        var textToCopy = copyText.value;
        
        // Add https:// prefix if not present
        if (!textToCopy.startsWith('http')) {
            textToCopy = 'https://' + textToCopy;
        }
        
        navigator.clipboard.writeText(textToCopy).then(function() {
            // Show feedback
            var btn = copyText.nextElementSibling;
            var originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.remove('btn-outline-secondary', 'btn-primary', 'btn-success');
            btn.classList.add('btn-success');
            
            setTimeout(function() {
                btn.innerHTML = originalHtml;
            }, 2000);
        });
    }
    </script>
{% endblock %}
